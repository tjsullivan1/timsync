apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-dns
  namespace: argocd
spec:
  project: default
  source:
    chart: external-dns
    repoURL: https://kubernetes-sigs.github.io/external-dns
    targetRevision: 1.14.0
    helm:
      values: |
        provider:
          name: azure
        sources:
          - gateway-httproute
        policy: sync
        txtOwnerId: "timsync-cluster"
        
        # Extra args for Azure configuration
        extraArgs:
          - --azure-resource-group=rg-dns
          - --azure-subscription-id=32dade7a-ad90-464c-a9f3-27221e9f9d73
          - --azure-config-file=/etc/kubernetes/azure.json
        
        # ServiceAccount with Workload Identity annotations
        serviceAccount:
          create: true
          name: external-dns
          annotations:
            azure.workload.identity/client-id: "13a33503-398c-4627-a1be-e96b2ef6c702"
          labels:
            azure.workload.identity/use: "true"
        
        # Pod label required for workload identity webhook to inject token
        podLabels:
          azure.workload.identity/use: "true"
        
        # Mount the azure.json config file
        extraVolumes:
          - name: azure-config
            secret:
              secretName: azure-dns-config
        
        extraVolumeMounts:
          - name: azure-config
            mountPath: /etc/kubernetes
            readOnly: true
  destination:
    server: https://kubernetes.default.svc
    namespace: external-dns
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
