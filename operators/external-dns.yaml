apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: external-dns
  namespace: argocd
spec:
  project: default
  source:
    chart: external-dns
    repoURL: https://kubernetes-sigs.github.io/external-dns
    targetRevision: 1.14.0
    helm:
      values: |
        provider: azure
        sources:
          - gateway-httproute
          - gateway-grpcroute
          - gateway-tlsroute
        policy: sync
        txtOwnerId: "timsync-cluster"
        
        # Azure-specific configuration
        azure:
          resourceGroup: "rg-dns"  # Resource group containing your DNS zone
          tenantId: "012c6d21-cad3-4e61-98dd-2bc660a112b8"
          subscriptionId: "32dade7a-ad90-464c-a9f3-27221e9f9d73"
          useWorkloadIdentityExtension: true
        
        # ServiceAccount with Workload Identity annotations
        serviceAccount:
          create: true
          name: external-dns
          annotations:
            azure.workload.identity/client-id: "13a33503-398c-4627-a1be-e96b2ef6c702"  # Update if using dedicated identity
          labels:
            azure.workload.identity/use: "true"
        
        # Pod label required for workload identity
        podLabels:
          azure.workload.identity/use: "true"
  destination:
    server: https://kubernetes.default.svc
    namespace: external-dns
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
